# XRAIN

## はじめに

このライブラリは国土交通省が提供するeXtended RAdar Information Network (XRAIN) のバイナリデータをRubyで解析するためのものです。XRAINは国土交通省によって運用されているC/Xバンド帯の気象レーダネットワークで、全国の主要都市をカバーしています。XRAINの詳しい仕様については[こちらのドキュメント](http://www.nilim.go.jp/lab/bcg/siryou/tnn/tnn0909pdf/ks090915.pdf)を御覧ください。

本ライブラリではXバンド帯レーダの生データおよび一次補正済みデータのバイナリを扱えます。合成雨量データは解析できません。各種データについては[東京大学データ統合・解析システムDIAS](https://diasjp.net/service/xrain-data/)より、申請・審査の上、ダウンロードが可能となります。

バイナリの仕様については国土交通省Ｘバンドレーダ雨量計 観測データ共通フォーマット仕様書 (Ver 0.83)に準拠しています (仕様書はDIASより登録後にダウンロードできます)。バイナリの仕様が変更になった場合は正常に解析ができない場合がありますので、ご注意ください。作成者では2016年12月から2019年1月までの観測データが読み込めることを確認しております。

なお本ライブラリを利用して生じた不利益・損害等について、作成者はその一切の責任を負いませんので、各自の責任でご利用ください。利用方法・不具合の報告、追加機能の実装については、可能な限り対処いたします。


## XRAINについて
XRAINはXバンド帯 (9 GHz帯) の電波を用いたマルチパラメータのレーダーネットワークです。各受信局では、CAPPI (constant altitude plan position indicator) と呼ばれる手法を用いて、レーダーエコーを3次元で測定しています。12の仰角が設定されており、5分間で全ての仰角を走査します。1分間で合計3つの合格が走査されます。12の仰角のうち、合成雨量に用いられる1番目と2番目はそれぞれ奇数分と偶数分に観測されます。残りの3番目から12番目の10の仰角は1分間で2仰角づつ、5分かけて観測されます。仰角の設定は観測サイト毎に異なりますので、以下で述べるコマンドなどを利用して確認してください。XRAINのバイナリデータは仰角ごとに区切られています。

XRAINの観測データは各仰角について極座標形式で格納されており、方位角方向をセクター、視線方向をレンジと呼びます。典型的に方位角方向は360度を300セクター、すなわち1セクターあたり1.2度で走査します。視線方向はレーダーから0.0 kmのから80.1 kmまでを584レンジに分割し、この場合の分解能は0.15 kmです。セクターおよびレンジの分割数や最大レンジは変更される可能性がありますので、データで確認してください。またセクターやレンジの概念は仕様書の図6-2を参照してください。

提供されるデータには生データと一次処理データがあります。例えば一次処理データには減衰補正済みレーダー反射因子データ、偏波の反射因子差、伝播位相差変化率などがあります。本ライブラリでは仕様書の表4-7に記述された変換係数を用いた変換後のデータを出力します。例えば一次処理データの減衰補正済みレーダー反射因子データでは単位dBZの値が返されます。

## ライブラリの使い方
まずライブラリを読み込むには
```
require "/path_to_library/lib/XRAIN.rb"
```
としてライブラリファイルを読み込ませてください。
```
radar=Xrain.new(inputFile)
```
とするとバイナリファイルが読み込まれます。`inputFile`にはバイナリファイルのパスを与えてください。ここではインスタンス名を`radar`としておきます。読み込みが終わるとライブラリのクレジットが表示されます。バッチ処理などでクレジットを表示させたくない場合は
```
radar=Xrain.new(inputFile, false)
```
とするとクレジットは表示されません。

レーダーの情報を一括表示するには
```
radar.parameter
```
とします。すると以下のようにデータが表示されます。
```
レーダーサイト     : 北陸/能美
データ種別         : レーダー反射因子 (dBZ)
データ配信日時     : 2016年12月08日 00時10分 (日本標準時)
XRAINステータス    : 正常
サイトステータス   : 正常
レーダー回転速度   : 3.5 rpm
運用モード         : CAPPI
CAPPI仰角数        : 12
CAPPI仰角番号      : 2
CAPPI仰角          : 3.6度
レーダーサイト緯度 : 北緯36度27分32秒
レーダーサイト経度 : 東経136度33分9秒
レーダーサイト高度 : 49.0 m
水平偏波送信電力   : 100.0 kW
垂直偏波送信電力   : 100.0 kW
送信周波数         : 9.785 GHz
観測開始時刻       : 00時09分03秒 (日本標準時)
観測終了時刻       : 00時09分20秒 (日本標準時)
視線方向最小距離   : 0.0 km
視線方向最大距離   : 80.1 km
視線方向ステップ   : 0.15 km
視線方向観測数     : 534
方位角観測数       : 300
```
この文字列を変数に格納したい場合は
```
radar.parameter(true)
```
とすると上記の文字列を返します。

i番目のセクタ (上記の例では0≦i≦299)、j番目のレンジ (0≦i≦533) の値は
```
radar.value(i, j)
```
で取得できます。

i番目のセクターの観測開始方位角を取得するには
```
radar.azimuth_start(i)
```
となります。i番目のセクターの観測終了方位角を取得するには
```
radar.azimuth_end(i)
```
となります。i番目のセクターの観測開始仰角を取得するには
```
radar.elevation_start(i)
```
となります。i番目のセクターの観測終了仰角を取得するには
```
radar.elevation_end(i)
```
となります。仰角はほとんど一定ですが、観測によってはセクターごとに仰角が若干異なる場合があります。平均仰角は
```
radar.elevation()
```
で取得できます。以上の角度の単位は全て度です。

観測レンジ数 (視線方向のデータ数) は
```
radar.range_num()
```
で取得できます。レンジの最小値と最大値はそれぞれ
```
radar.range_min()
radar.range_max()
```
で取得できます。レンジの分解能は
```
radar.range_step()
```
で取得できます。最小値・最大値・分解能の単位はkmです。

方位角方向のデータ数は
```
radar.azimuth_num()
```
で取得できます。

データの配信日と時刻はそれぞれ
```
radar.date()
radar.time()
```
で取得できます。いずれも日本標準時 (JST)です。走査開始・終了時刻はそれぞれ
```
radar.obs_start()
radar.obs_end()
```
で取得できます。

## サンプルスクリプト
ライブラリの使用例として、バイナリファイルを読み込ませると観測パラメータをテキストで、データをCSVで出力するサンプルコードを準備しました。以下のようにして使用できます。
```
ruby bin2csv.rb /path_to_file/name_of_file /path_of_output/
```
出力されたCSVファイルは行ごとに1セクターのデータが格納されています。セクター数300レンジ数534の場合、534列300行のCSVファイルとなっています。

## 最後に
スクリプトに不備がある場合や追加機能の実装を希望される場合はissueを上げてください。XRAINのバイナリ解析スクリプトはフリーソフトがほとんど見つかりません。学術用途など皆様のお役に経てば幸いです。
